name: Add Tech Notes to GitHub Issue
permissions:
  contents: read
  issues: write

on:
  push:
    paths:
      - "docs/tech_notes/*.md"

jobs:
  add-tech-notes-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Add comments to issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          echo "üìù Start processing tech notes..."

          for file in $(find docs/tech_notes -type f -name "Task_*.md"); do
            echo "üìÑ Processing file: $file"
            filename=$(basename "$file")
            issue_number=$(echo "$filename" | sed -n 's/Task_\([0-9]\+\)\.md/\1/p')
            
            if [ -z "$issue_number" ]; then
              echo "‚ö†Ô∏è Brak numeru issue w nazwie pliku: $filename"
              continue
            fi

            echo "üî¢ Issue number found: $issue_number"
            content=$(cat "$file")

            # Escapowanie zawarto≈õci do formatu JSON (dla curl)
            escaped_content=$(printf '%s\n' "$content" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

            # Wysy≈Çanie komentarza przez GitHub API
            response=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
              -H "Authorization: token $GH_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"body\": \"### Tech Notes\\n$escaped_content\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${issue_number}/comments")

            if [ "$response" = "201" ]; then
              echo "‚úÖ Komentarz dodany do Issue #$issue_number"
            else
              echo "‚ùå B≈ÇƒÖd przy dodawaniu komentarza do Issue #$issue_number (kod HTTP: $response)"
            fi
          done
